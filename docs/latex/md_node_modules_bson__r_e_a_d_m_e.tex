B\+S\+ON is short for Bin­ary J\+S\+ON and is the bin­ary-\/en­coded seri­al­iz­a­tion of J\+S\+O\+N-\/like doc­u­ments. You can learn more about it in \href{http://bsonspec.org}{\tt the specification}.

This browser version of the B\+S\+ON parser is compiled using \href{https://webpack.js.org/}{\tt webpack} and the current version is pre-\/compiled in the {\ttfamily browser\+\_\+build} directory.

This is the default B\+S\+ON parser, however, there is a C++ Node.\+js addon version as well that does not support the browser. It can be found at \href{https://github.com/mongodb-js/bson-ext}{\tt mongod-\/js/bson-\/ext}.

\subsection*{Usage}

To build a new version perform the following operations\+:


\begin{DoxyCode}
npm install
npm run build
\end{DoxyCode}


A simple example of how to use B\+S\+ON in the browser\+:


\begin{DoxyCode}
<script src="./browser\_build/bson.js"></script>

<script>
  function start() \{
    // Get the Long type
    var Long = BSON.Long;
    // Create a bson parser instance
    var bson = new BSON();

    // Serialize document
    var doc = \{ long: Long.fromNumber(100) \}

    // Serialize a document
    var data = bson.serialize(doc)
    // De serialize it again
    var doc\_2 = bson.deserialize(data)
  \}
</script>
\end{DoxyCode}


A simple example of how to use B\+S\+ON in {\ttfamily Node.\+js}\+:


\begin{DoxyCode}
// Get BSON parser class
var BSON = require('bson')
// Get the Long type
var Long = BSON.Long;
// Create a bson parser instance
var bson = new BSON();

// Serialize document
var doc = \{ long: Long.fromNumber(100) \}

// Serialize a document
var data = bson.serialize(doc)
console.log('data:', data)

// Deserialize the resulting Buffer
var doc\_2 = bson.deserialize(data)
console.log('doc\_2:', doc\_2)
\end{DoxyCode}


\subsection*{Installation}

{\ttfamily npm install bson}

\subsection*{A\+PI}

\subsubsection*{B\+S\+ON types}

For all B\+S\+ON types documentation, please refer to the following sources\+:
\begin{DoxyItemize}
\item \href{https://docs.mongodb.com/manual/reference/bson-types/}{\tt Mongo\+DB B\+S\+ON Type Reference}
\item \href{https://bsonspec.org/}{\tt B\+S\+ON Spec}
\end{DoxyItemize}

\subsubsection*{B\+S\+ON serialization and deserialiation}

$\ast$$\ast${\ttfamily new B\+S\+O\+N()}$\ast$$\ast$ -\/ Creates a new B\+S\+ON serializer/deserializer you can use to serialize and deserialize B\+S\+ON.

\paragraph*{B\+S\+O\+N.\+serialize}

The B\+S\+ON {\ttfamily serialize} method takes a Java\+Script object and an optional options object and returns a Node.\+js Buffer.


\begin{DoxyItemize}
\item {\ttfamily B\+S\+O\+N.\+serialize(object, options)}
\begin{DoxyItemize}
\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & object the Java\+Script object to serialize.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+check\+Keys=false\mbox{]} the serializer will check if keys are valid.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+serialize\+Functions=false\mbox{]} serialize the Java\+Script functions.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+ignore\+Undefined=true\mbox{]}\\
\hline
\end{DoxyParams}

\item \begin{DoxyReturn}{Returns}
\{Buffer\} returns a Buffer instance.
\end{DoxyReturn}
\paragraph*{B\+S\+O\+N.\+serialize\+With\+Buffer\+And\+Index}
\end{DoxyItemize}
\end{DoxyItemize}

The B\+S\+ON {\ttfamily serialize\+With\+Buffer\+And\+Index} method takes an object, a target buffer instance and an optional options object and returns the end serialization index in the final buffer.


\begin{DoxyItemize}
\item {\ttfamily B\+S\+O\+N.\+serialize\+With\+Buffer\+And\+Index(object, buffer, options)}
\begin{DoxyItemize}
\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & object the Java\+Script object to serialize.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Buffer\}} & buffer the Buffer you pre-\/allocated to store the serialized B\+S\+ON object.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+check\+Keys=false\mbox{]} the serializer will check if keys are valid.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+serialize\+Functions=false\mbox{]} serialize the Java\+Script functions.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+ignore\+Undefined=true\mbox{]} ignore undefined fields.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Number\}} & \mbox{[}options.\+index=0\mbox{]} the index in the buffer where we wish to start serializing into.\\
\hline
\end{DoxyParams}

\item \begin{DoxyReturn}{Returns}
\{Number\} returns the index pointing to the last written byte in the buffer.
\end{DoxyReturn}
\paragraph*{B\+S\+O\+N.\+calculate\+Object\+Size}
\end{DoxyItemize}
\end{DoxyItemize}

The B\+S\+ON {\ttfamily calculate\+Object\+Size} method takes a Java\+Script object and an optional options object and returns the size of the B\+S\+ON object.


\begin{DoxyItemize}
\item {\ttfamily B\+S\+O\+N.\+calculate\+Object\+Size(object, options)}
\begin{DoxyItemize}
\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & object the Java\+Script object to serialize.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+serialize\+Functions=false\mbox{]} serialize the Java\+Script functions.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Boolean\}} & \mbox{[}options.\+ignore\+Undefined=true\mbox{]}\\
\hline
\end{DoxyParams}

\item \begin{DoxyReturn}{Returns}
\{Buffer\} returns a Buffer instance.
\end{DoxyReturn}
\paragraph*{B\+S\+O\+N.\+deserialize}
\end{DoxyItemize}
\end{DoxyItemize}

The B\+S\+ON {\ttfamily deserialize} method takes a Node.\+js Buffer and an optional options object and returns a deserialized Java\+Script object.


\begin{DoxyItemize}
\item {\ttfamily B\+S\+O\+N.\+deserialize(buffer, options)}
\begin{DoxyItemize}
\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+eval\+Functions=false\mbox{]} evaluate functions in the B\+S\+ON document scoped to the object deserialized.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+cache\+Functions=false\mbox{]} cache evaluated functions for reuse.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+cache\+Functions\+Crc32=false\mbox{]} use a crc32 code for caching, otherwise use the string of the function.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+promote\+Longs=true\mbox{]} when deserializing a Long will fit it into a Number if it\textquotesingle{}s smaller than 53 bits\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+promote\+Buffers=false\mbox{]} when deserializing a Binary will return it as a Node.\+js Buffer instance.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+promote\+Values=false\mbox{]} when deserializing will promote B\+S\+ON values to their Node.\+js closest equivalent types.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+fields\+As\+Raw=null\mbox{]} allow to specify if there what fields we wish to return as unserialized raw buffer.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+bson\+Reg\+Exp=false\mbox{]} return B\+S\+ON regular expressions as B\+S\+O\+N\+Reg\+Exp instances.\\
\hline
\end{DoxyParams}

\item \begin{DoxyReturn}{Returns}
\{Object\} returns the deserialized Javascript Object.
\end{DoxyReturn}
\paragraph*{B\+S\+O\+N.\+deserialize\+Stream}
\end{DoxyItemize}
\end{DoxyItemize}

The B\+S\+ON {\ttfamily deserialize\+Stream} method takes a Node.\+js Buffer, {\ttfamily start\+Index} and allow more control over deserialization of a Buffer containing concatenated B\+S\+ON documents.


\begin{DoxyItemize}
\item {\ttfamily B\+S\+O\+N.\+deserialize\+Stream(buffer, start\+Index, number\+Of\+Documents, documents, doc\+Start\+Index, options)}
\begin{DoxyItemize}
\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Buffer\}} & buffer the buffer containing the serialized set of B\+S\+ON documents.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Number\}} & start\+Index the start index in the data Buffer where the deserialization is to start.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Number\}} & number\+Of\+Documents number of documents to deserialize.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Array\}} & documents an array where to store the deserialized documents.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Number\}} & doc\+Start\+Index the index in the documents array from where to start inserting documents.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+eval\+Functions=false\mbox{]} evaluate functions in the B\+S\+ON document scoped to the object deserialized.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+cache\+Functions=false\mbox{]} cache evaluated functions for reuse.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+cache\+Functions\+Crc32=false\mbox{]} use a crc32 code for caching, otherwise use the string of the function.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+promote\+Longs=true\mbox{]} when deserializing a Long will fit it into a Number if it\textquotesingle{}s smaller than 53 bits\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+promote\+Buffers=false\mbox{]} when deserializing a Binary will return it as a Node.\+js Buffer instance.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+promote\+Values=false\mbox{]} when deserializing will promote B\+S\+ON values to their Node.\+js closest equivalent types.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+fields\+As\+Raw=null\mbox{]} allow to specify if there what fields we wish to return as unserialized raw buffer.\\
\hline
\end{DoxyParams}

\item 
\begin{DoxyParams}{Parameters}
{\em \{\+Object\}} & \mbox{[}options.\+bson\+Reg\+Exp=false\mbox{]} return B\+S\+ON regular expressions as B\+S\+O\+N\+Reg\+Exp instances.\\
\hline
\end{DoxyParams}

\item \begin{DoxyReturn}{Returns}
\{Number\} returns the next index in the buffer after deserialization {\bfseries x} numbers of documents.
\end{DoxyReturn}
\subsection*{F\+AQ}
\end{DoxyItemize}
\end{DoxyItemize}

\paragraph*{Why does {\ttfamily undefined} get converted to {\ttfamily null}?}

The {\ttfamily undefined} B\+S\+ON type has been \href{http://bsonspec.org/spec.html}{\tt deprecated for many years}, so this library has dropped support for it. Use the {\ttfamily ignore\+Undefined} option (for example, from the \href{http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html#connect}{\tt driver} ) to instead remove {\ttfamily undefined} keys.

\paragraph*{How do I add custom serialization logic?}

This library looks for {\ttfamily to\+B\+S\+O\+N()} functions on every path, and calls the {\ttfamily to\+B\+S\+O\+N()} function to get the value to serialize.


\begin{DoxyCode}
var bson = new BSON();

class CustomSerialize \{
  toBSON() \{
    return 42;
  \}
\}

const obj = \{ answer: new CustomSerialize() \};
// "\{ answer: 42 \}"
console.log(bson.deserialize(bson.serialize(obj)));
\end{DoxyCode}
 