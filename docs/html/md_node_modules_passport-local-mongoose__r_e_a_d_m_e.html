<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Camply: Passport-Local Mongoose</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="camply.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Camply
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">Camply is a social platform that users can share their own experiences.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Passport-Local Mongoose </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Passport-Local Mongoose is a <a href="http://mongoosejs.com/">Mongoose</a> <a href="http://mongoosejs.com/docs/plugins.html">plugin</a> that simplifies building username and password login with <a href="http://passportjs.org">Passport</a>.</p>
<p><a href="https://travis-ci.org/saintedlama/passport-local-mongoose"></a> <a href="https://coveralls.io/r/saintedlama/passport-local-mongoose?branch=master"></a> <a href="https://app.codellama.io/repositories/5a04399c1b4c363a0f9427f8"></a></p>
<h2>Tutorials</h2>
<p>Michael Herman gives a comprehensible walk through for setting up mongoose, passport, passport-local and passport-local-mongoose for user authentication in his blog post <a href="http://mherman.org/blog/2013/11/11/user-authentication-with-passport-dot-js/">User Authentication With Passport.js</a></p>
<h2>Installation</h2>
<div class="fragment"><div class="line">&gt; npm install passport-local-mongoose</div></div><!-- fragment --><p>Passport-Local Mongoose does not require <code>passport</code>, <code>passport-local</code> or <code>mongoose</code> dependencies directly but expects you to have these dependencies installed.</p>
<p>In case you need to install the whole set of dependencies</p>
<div class="fragment"><div class="line">&gt; npm install passport passport-local mongoose passport-local-mongoose --save</div></div><!-- fragment --><h3>Updating from 1.x to 2.x</h3>
<p>The default digest algorithm was changed due to security implications from <b>sha1</b> to <b>sha256</b>. If you decide to upgrade a production system from 1.x to 2.x your users <b>will not be able to login</b> since the digest algorithm was changed! In these cases plan some migration strategy and/or use the <b>sha1</b> option for the digest algorithm.</p>
<h2>Usage</h2>
<h3>Plugin Passport-Local Mongoose</h3>
<p>First you need to plugin Passport-Local Mongoose into your User schema</p>
<div class="fragment"><div class="line">const mongoose = require(&#39;mongoose&#39;);</div><div class="line">const Schema = mongoose.Schema;</div><div class="line">const passportLocalMongoose = require(&#39;passport-local-mongoose&#39;);</div><div class="line"></div><div class="line">const User = new Schema({});</div><div class="line"></div><div class="line">User.plugin(passportLocalMongoose);</div><div class="line"></div><div class="line">module.exports = mongoose.model(&#39;User&#39;, User);</div></div><!-- fragment --><p>You're free to define your User how you like. Passport-Local Mongoose will add a username, hash and salt field to store the username, the hashed password and the salt value.</p>
<p>Additionally Passport-Local Mongoose adds some methods to your Schema. See the API Documentation section for more details.</p>
<h3>Configure Passport/Passport-Local</h3>
<p>You should configure Passport/Passport-Local as described in <a href="http://passportjs.org/guide/configure/">the Passport Guide</a>.</p>
<p>Passport-Local Mongoose supports this setup by implementing a <code>LocalStrategy</code> and serializeUser/deserializeUser functions.</p>
<p>To setup Passport-Local Mongoose use this code</p>
<div class="fragment"><div class="line">// requires the model with Passport-Local Mongoose plugged in</div><div class="line">const User = require(&#39;./models/user&#39;);</div><div class="line"></div><div class="line">// use static authenticate method of model in LocalStrategy</div><div class="line">passport.use(new LocalStrategy(User.authenticate()));</div><div class="line"></div><div class="line">// use static serialize and deserialize of model for passport session support</div><div class="line">passport.serializeUser(User.serializeUser());</div><div class="line">passport.deserializeUser(User.deserializeUser());</div></div><!-- fragment --><p>Make sure that you have a mongoose connected to mongodb and you're done.</p>
<h4>Simplified Passport/Passport-Local Configuration</h4>
<p>Starting with version 0.2.1 passport-local-mongoose adds a helper method <code>createStrategy</code> as static method to your schema. The <code>createStrategy</code> is responsible to setup passport-local <code>LocalStrategy</code> with the correct options.</p>
<div class="fragment"><div class="line">const User = require(&#39;./models/user&#39;);</div><div class="line"></div><div class="line">// CHANGE: USE &quot;createStrategy&quot; INSTEAD OF &quot;authenticate&quot;</div><div class="line">passport.use(User.createStrategy());</div><div class="line"></div><div class="line">passport.serializeUser(User.serializeUser());</div><div class="line">passport.deserializeUser(User.deserializeUser());</div></div><!-- fragment --><p>The reason for this functionality is that when using the <code>usernameField</code> option to specify an alternative usernameField name, for example "email" passport-local would still expect your frontend login form to contain an input field with name "username" instead of email. This can be configured for passport-local but this is double the work. So we got this shortcut implemented.</p>
<h3>Async/Await</h3>
<p>Starting with version <code>5.0.0</code> passport-local-mongoose is async/await enabled by returning Promises for all instance and static methods except <code>serializeUser</code> and <code>deserializeUser</code>.</p>
<div class="fragment"><div class="line">const user = new DefaultUser({username: &#39;user&#39;});</div><div class="line">await user.setPassword(&#39;password&#39;);</div><div class="line">await user.save();</div><div class="line">const { user } = await DefaultUser.authenticate()(&#39;user&#39;, &#39;password&#39;);</div></div><!-- fragment --><h3>Options</h3>
<p>When plugging in Passport-Local Mongoose plugin additional options can be provided to configure the hashing algorithm.</p>
<div class="fragment"><div class="line">User.plugin(passportLocalMongoose, options);</div></div><!-- fragment --><h4>Main Options</h4>
<ul>
<li>saltlen: specifies the salt length in bytes. Default: 32</li>
<li>iterations: specifies the number of iterations used in pbkdf2 hashing algorithm. Default: 25000</li>
<li>keylen: specifies the length in byte of the generated key. Default: 512</li>
<li>digestAlgorithm: specifies the pbkdf2 digest algorithm. Default: sha256. (get a list of supported algorithms with crypto.getHashes())</li>
<li>interval: specifies the interval in milliseconds between login attempts, which increases exponentially based on the number of failed attempts, up to maxInterval. Default: 100</li>
<li>maxInterval: specifies the maximum amount of time an account can be locked. Default 30000 (5 minutes)</li>
<li>usernameField: specifies the field name that holds the username. Defaults to 'username'. This option can be used if you want to use a different field to hold the username for example "email".</li>
<li>usernameUnique : specifies if the username field should be enforced to be unique by a mongodb index or not. Defaults to true.</li>
<li>saltField: specifies the field name that holds the salt value. Defaults to 'salt'.</li>
<li>hashField: specifies the field name that holds the password hash value. Defaults to 'hash'.</li>
<li>attemptsField: specifies the field name that holds the number of login failures since the last successful login. Defaults to 'attempts'.</li>
<li>lastLoginField: specifies the field name that holds the timestamp of the last login attempt. Defaults to 'last'.</li>
<li>selectFields: specifies the fields of the model to be selected from mongodb (and stored in the session). Defaults to 'undefined' so that all fields of the model are selected.</li>
<li>usernameLowerCase: convert username field value to lower case when saving an querying. Defaults to 'false'.</li>
<li>populateFields: specifies fields to populate in findByUsername function. Defaults to 'undefined'.</li>
<li>encoding: specifies the encoding the generated salt and hash will be stored in. Defaults to 'hex'.</li>
<li>limitAttempts: specifies whether login attempts should be limited and login failures should be penalized. Default: false.</li>
<li>maxAttempts: specifies the maximum number of failed attempts allowed before preventing login. Default: Infinity.</li>
<li>passwordValidator: specifies your custom validation function for the password in the form 'function(password,cb)'. Default: validates non-empty passwords.</li>
<li>usernameQueryFields: specifies alternative fields of the model for identifying a user (e.g. email).</li>
<li>findByUsername: Specifies a query function that is executed with query parameters to restrict the query with extra query parameters. For example query only users with field "active" set to <code>true</code>. Default: <code>function(model, queryParameters) { return model.findOne(queryParameters); }</code>. See the examples section for a use case.</li>
</ul>
<p><em>Attention!</em> Changing any of the hashing options (saltlen, iterations or keylen) in a production environment will prevent that existing users to authenticate!</p>
<h4>Error Messages</h4>
<p>Override default error messages by setting options.errorMessages.</p>
<ul>
<li>MissingPasswordError 'No password was given'</li>
<li>AttemptTooSoonError 'Account is currently locked. Try again later'</li>
<li>TooManyAttemptsError 'Account locked due to too many failed login attempts'</li>
<li>NoSaltValueStoredError 'Authentication not possible. No salt value stored'</li>
<li>IncorrectPasswordError 'Password or username are incorrect'</li>
<li>IncorrectUsernameError 'Password or username are incorrect'</li>
<li>MissingUsernameError 'No username was given'</li>
<li>UserExistsError 'A user with the given username is already registered'</li>
</ul>
<h3>Hash Algorithm</h3>
<p>Passport-Local Mongoose use the pbkdf2 algorithm of the node crypto library. <a href="http://en.wikipedia.org/wiki/PBKDF2">Pbkdf2</a> was chosen because platform independent (in contrary to bcrypt). For every user a generated salt value is saved to make rainbow table attacks even harder.</p>
<h3>Examples</h3>
<p>For a complete example implementing a registration, login and logout see the <a href="https://github.com/saintedlama/passport-local-mongoose/tree/master/examples/login">login example</a>.</p>
<h2>API Documentation</h2>
<h3>Instance methods</h3>
<h4>setPassword(password, [cb])</h4>
<p>Sets a user password. Does not save the user object. If no callback <code>cb</code> is provided a <code>Promise</code> is returned.</p>
<h4>changePassword(oldPassword, newPassword, [cb])</h4>
<p>Changes a user's password hash and salt and saves the user object. If no callback <code>cb</code> is provided a <code>Promise</code> is returned. If oldPassword does not match the user's old password an <code>IncorrectPasswordError</code> is passed to <code>cb</code> or the <code>Promise</code> is rejected.</p>
<h4>authenticate(password, [cb])</h4>
<p>Authenticate a user object. If no callback <code>cb</code> is provided a <code>Promise</code> is returned.</p>
<h4>resetAttempts([cb])</h4>
<p>Reset a user's number of failed password attempts (only defined if <code>options.limitAttempts</code> is true) If no callback <code>cb</code> is provided a <code>Promise</code> is returned.</p>
<h3>Callback Arguments</h3>
<ul>
<li>err<ul>
<li>null unless the hasing algorithm throws an error</li>
</ul>
</li>
<li>thisModel<ul>
<li>the model getting authenticated <em>if</em> authentication was successful otherwise false</li>
</ul>
</li>
<li>passwordErr<ul>
<li>an instance of <code>AuthenticationError</code> describing the reason the password failed, else undefined.</li>
</ul>
</li>
</ul>
<p>Using <code>setPassword()</code> will only update the document's password fields, but will not save the document. To commit the changed document, remember to use Mongoose's <code>document.save()</code> after using <code>setPassword()</code>.</p>
<h3>Error Handling</h3>
<ul>
<li><code>IncorrectPasswordError</code>: specifies the error message returned when the password is incorrect. Defaults to 'Incorrect password'.</li>
<li><code>IncorrectUsernameError</code>: specifies the error message returned when the username is incorrect. Defaults to 'Incorrect username'.</li>
<li><code>MissingUsernameError</code>: specifies the error message returned when the username has not been set during registration. Defaults to 'Field s is not set'.</li>
<li><code>MissingPasswordError</code>: specifies the error message returned when the password has not been set during registration. Defaults to 'Password argument not set!'.</li>
<li><code>UserExistsError</code>: specifies the error message returned when the user already exists during registration. Defaults to 'User already exists with name s'.</li>
<li><code>NoSaltValueStored</code>: Occurs in case no salt value is stored in the MongoDB collection.</li>
<li><code>AttemptTooSoonError</code>: Occurs if the option <code>limitAttempts</code> is set to true and a login attept occures while the user is still penalized.</li>
<li><code>TooManyAttemptsError</code>: Returned when the user's account is locked due to too many failed login attempts.</li>
</ul>
<p>All those errors inherit from <code>AuthenticationError</code>, if you need a more general error class for checking.</p>
<h3>Static methods</h3>
<p>Static methods are exposed on the model constructor. For example to use createStrategy function use</p>
<div class="fragment"><div class="line">const User = require(&#39;./models/user&#39;);</div><div class="line">User.createStrategy();</div></div><!-- fragment --><ul>
<li>authenticate() Generates a function that is used in Passport's LocalStrategy</li>
<li>serializeUser() Generates a function that is used by Passport to serialize users into the session</li>
<li>deserializeUser() Generates a function that is used by Passport to deserialize users into the session</li>
<li>register(user, password, cb) Convenience method to register a new user instance with a given password. Checks if username is unique. See <a href="https://github.com/saintedlama/passport-local-mongoose/tree/master/examples/login">login example</a>.</li>
<li>findByUsername() Convenience method to find a user instance by it's unique username.</li>
<li>createStrategy() Creates a configured passport-local <code>LocalStrategy</code> instance that can be used in passport.</li>
</ul>
<h2>Examples</h2>
<h3>Allow only "active" users to authenticate</h3>
<p>First we define a schema with an additional field <code>active</code> of type Boolean.</p>
<div class="fragment"><div class="line">var UserSchema = new Schema({</div><div class="line">  active: Boolean</div><div class="line">});</div></div><!-- fragment --><p>When plugging in Passport-Local Mongoose we set <code>usernameUnique</code> to avoid creating a unique mongodb index on field <code>username</code>. To avoid non active users to be queried by mongodb we can specify the option <code>findByUsername</code> that allows us to restrict a query. In our case we want to restrict the query to only query users with field <code>active</code> set to <code>true</code>. The <code>findByUsername</code> MUST return a Mongoose query.</p>
<div class="fragment"><div class="line">UserSchema.plugin(passportLocalMongoose, {</div><div class="line">  // Needed to set usernameUnique to true to avoid a mongodb index on the username column!</div><div class="line">  usernameUnique: false,</div><div class="line"></div><div class="line">  findByUsername: function(model, queryParameters) {</div><div class="line">    // Add additional query parameter - AND condition - active: true</div><div class="line">    queryParameters.active = true;</div><div class="line">    return model.findOne(queryParameters);</div><div class="line">  }</div><div class="line">});</div></div><!-- fragment --><p>To test the implementation we can simply create (register) a user with field <code>active</code> set to <code>false</code> and try to authenticate this user in a second step:</p>
<div class="fragment"><div class="line">var User = mongoose.model(&#39;Users&#39;, UserSchema);</div><div class="line"></div><div class="line">User.register({username:&#39;username&#39;, active: false}, &#39;password&#39;, function(err, user) {</div><div class="line">  if (err) { ... }</div><div class="line"></div><div class="line">  var authenticate = User.authenticate();</div><div class="line">  authenticate(&#39;username&#39;, &#39;password&#39;, function(err, result) {</div><div class="line">    if (err) { ... }</div><div class="line"></div><div class="line">    // Value &#39;result&#39; is set to false. The user could not be authenticated since the user is not active</div><div class="line">  });</div><div class="line">});</div></div><!-- fragment --><h2>License</h2>
<p>Passport-Local Mongoose is licenses under the <a href="http://opensource.org/licenses/MIT">MIT license</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
